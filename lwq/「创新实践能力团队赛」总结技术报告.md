# 「创新实践能力团队赛」总结技术报告

姓名：李文茜

学号：2020212063056

班级：2020级网络空间安全1班

## 一、实验环境

小组采用了`Windows`环境代码书写开发，完成后移植到`Linux`系统的方式。实验以`Windows`环境采用完成了`Python`、`Apache`和`MySQL`的封装配置；`Linux`系统则使用自安装的`PHP`、`Apache`和`MySQL`。

## 二、实验完成部分

注册、登录、首页部分的前端。

## 三、实验要求

任务一：基于网页的文件上传加密与数字签名系统

●使用`https`绑定证书到域名而非IP地址 **【 PKI X.509 】**

●允许用户注册到系统

  ○用户名的合法字符集范围：中文、英文字母、数字

●类似：-、_、.等合法字符集范围之外的字符不允许使用

  ○用户口令长度限制在36个字符之内

  ○对用户输入的口令进行强度校验，禁止使用弱口令

●使用合法用户名和口令登录系统

●禁止使用明文存储用户口令 

○存储的口令即使被公开，也无法还原/解码出原始明文口令



该用户注册登录系统为前后端交互。

**前端页面：**

1.`注册页面.php`

注册页面由**“用户注册页面”的标题**和**一个收集用户信息的表单**组成。

表单是该页面的核心部分，将用户填写的信息传递给后台`check.php`，便于管理员收集信息处理后加入数据库，由于涉及到用户的密码等个人因此信息，因此前后端交互递交信息使用`post`方式，表单中用`table`表格格式化，对于用户名使用`text`类型，对于密码使用`password`类型`input`，下方有提交的“注册”按钮和直接链接到登录页面的“登陆”按钮。

![code1](\img\code1.png)

![code2](\img\code2.png)

对页面进行`css`优化后得到如下效果图

![play1](\img\play1.png)

![play2](\img\play2.png)

2.`check.php`

在此处实现用户填写信息的完整性和规范性。如果用户提交的信息不满足需求（eg.信息任意项为空、用户名包含-、_、.等合法字符集范围之外的字符，密码强度太弱），浏览器返回相应的错误提示，并回到注册页面要求用户再次输入信息。

![code3](\img\code3.png)

如果确认用户的输入信息完全规范，并且两次输入的密码完全一致之后就可以链接数据库。

![code4](\img\code4.png)

`select`操作查询该用户名是否已经存在于数据库的对应表中，如果用户名不重复，利用`libsodium`库中的

```
string sodium_crypto_pwhash(int $output_length, string $password, string $salt, int $opslimit, int $memlimit)
```

函数对用户的明文口令进行hash，将hash后的结果和过程中随机生成的盐值与对应的用户名一起存入数据库，随后提示用户注册成功，自动转到登录页面。

对于Argon2的加密部分进行详细分析：

```
$salt = random_bytes(SODIUM_CRYPTO_PWHASH_SALTBYTES);
$out_len = SODIUM_CRYPTO_SIGN_SEEDBYTES; 
$seed=sodium_crypto_pwhash($out_len,$password,$salt, SODIUM_CRYPTO_PWHASH_OPSLIMIT_INTERACTIVE, SODIUM_CRYPTO_PWHASH_MEMLIMIT_INTERACTIVE);
```

首先生成一个随机的16位盐值，然后闲置输出长度为32位，调用`sodium_crypto_pwhash()`函数，输入参数分别是 输出长度，加密的明文口令，盐值，函数推荐的两个库常量。

再对信息进行注册，用使用注册系统和数据库验证。

使用注册系统和数据库验证

3.`登录页面.php`

与注册页面基本相同。

![code5](\img\code5.png)

页面效果：

![play3](\img\play3.png)

4.`Logincheck.php`

接受提交表单中的信息并将其保存在常量中，如果用户名和密码都不为空，则连接数据库，并选定数据库和表。

![code6](\img\code6.png)

![code7](\img\code7.png)

要对用户输入的口令进行校验需要用到和注册时同样的加密哈希函数，由于注册时生成的盐值是随机的，因此用统一算法校验时，需要用到注册时生成的唯一盐值，在注册时和用户名以及生成的散列值一起被储存在数据库中。

首先要将与用户名对应的盐值取出存放于常量中，`select`与用户输入用户名相同的记录，将其转化为关联数组，取出属性名为`salt`的项的值赋给`salt`变量，随后用用户给出的口令与盐值和输出长度一起进行相同的哈希运算，将得到的结果与数据库中存放的散列值进行比较，若一致则通过验证，用户登陆成功。

因为后面文件上传时要求限制匿名用户的操作功能，因此要在登陆成功时进行session_start()函数的调用，记录某一用户访问该网站的cookie，并将用户名存入SESSION的系统常量中，以便后面文件上传时进行身份判别。

![code8](\img\code8.png)

该用户存在于数据库，验证通过。

![play4](\img\play4.png)

5.`index.php`

制作一个网站首页，使用户输入固定`ip`绑定的域名就可以直接访问首页。。

首页提供连接到注册页面，登录页面，文件上传页面和文件下载页面的四个链接。

`html`结构非常简单，就是用`ul`制作一个横向的导航栏，进行`css`优化后得到下面的页面效果。

![play5](\img\play5.png)

任务二：基于网页的文件上传加密与数字签名系统

●限制文件类型：office文档、常见图片类型

●匿名用户禁止上传文件

●对文件进行对称加密存储到文件系统，禁止明文存储文件

●限制文件大小：< 10MB

●系统对加密后文件进行数字签名 



6.`upload.php`

接下来做文件上传页面，与前项页面相比，在表单的`form`基础项上机上了`enctype`属性，`enctype` 属性规定在发送到服务器之前应该如何对表单数据进行编码。`multipart/from-data` 值表示不对字符编码，在使用包含文件上传空间的表单时，必须使用该项。

依旧使用`table`来规范格式，需要提一下的就是`input`自带的文件上传控件，类型值为`file`的`input`支持在电脑中浏览选中文件这一操作的；基本的`HTML`代码如下：

![code9](\img\code9.png)

经过`css`优化后的页面效果如下：

![play6](\img\play6.png)

7.`Uploadprogress.php`

`upload.php`中，为了控制匿名用户对文件上传的权限，在`uploadprogress.php`中首先调用`session_start()`并检验`$_SESSION[‘username’]`的状态是否为空，浏览器会根据`cookies`的值来判断该用户是否已经登录 

![code10](\img\code10.png)

在不登陆的情况下直接访问文件上传页面，即使填写的用户名是数据库存在的名字也会弹出窗口告知用户登陆，点击确定后直接转到登录页面，用户进行登陆后即可上传文件。

对上传的文件进行限制：

（1.文件大小不超过10M

![code11](\img\code11.png)

（2.文件类型进行限定

![code12](\img\code12.png)

文件上传无误后，以只读模式打开文件，将其中内容以二进制读入变量`$buf`中，并转化为16进制`$hex`；生成随机加密密钥和加密数据，大小分别为32和24，调用`sodium_crypto_secretbox(message,nonce,key)`函数对文件进行加密，转换为16进制存储，最后关闭文件。再以写入模式打开文件，清除文件所有内容，并将生成的加密密钥和加密数据和最终密文依次写入文件后关闭文件。为每个用户建立自己的文件夹，每次上传时判断是否有重名文件，如果有则不用再次保存，如果没有将文件从临时文件夹转存到固定的用户文件夹。之后用户即可正确上传文件。

文件的私钥签名认证功能：首先生成唯一合理可使用的证书文件和密钥文件，执行对应`PHP`代码后在同文件夹下生成相应的文件。随后在加密数据的后面添加代码。私钥签名得到加密签名后的数据`$signMsg`，由于不知道生成的密文长度和签名信息长度，将其放在同一段文件中会造成解密时取出长度未知的错误或麻烦，所以在将加密过后的文件成功转移到目标文件夹之后，在该文件夹下创建一个同名的`sign.txt`中存放签名。对文件code.txt进行上传，用户文件夹中出现code.txt和code.txtsign.txt两个文件。



任务三：基于网页的加密文件下载与解密

●提供匿名用户加密后文件和关联的数字签名文件的下载

  ○客户端对下载后的文件进行数字签名验证 

 ○客户端对下载后的文件可以解密还原到原始文件

●提供已登录用户解密后文件下载

●下载URL设置有效期（限制时间或限制下载次数），过期后禁止访问 

●提供静态文件的散列值下载，供下载文件完成后本地校验文件完整性

8.`download.php`

用户直接输入用户名和文件名，在储存文件的文件夹中对指定文件进行解密验证并将文件转存到用户希望的目录中去。

9.`downloadprogress.php`

在该下载界面填写文件下载信息，相应文件会被拷贝到指定文件夹中。

首先接受用户输入的变量将其存入。再读取密钥文件进行验证。验证成功后继续解密操作。（为加密过程的逆操作：根据大小依次取出存放在文件中的密钥和随机数以及密文，再用`sodium_crypto_secretbox_open`函数进行解密，之后将揭秘完成的内容重新写入文件）

## 三、实验问题及解决

1.为了方便对整个网页的总览，制作首页index.php，因此在其基础上将“用户注册页面”的h1标题改为a标签，用户可以在通过点击该链接直接回到首页。

![code13](\img\code13.npg)

2.在linux系统中test，一二行分别为生成的盐值和哈希口令的二进制值，因为会出现乱码可读性差，因此转化为16进制表示及存储。

3.校验信息规范性的操作都是在后端完成的，因此需要用户点击提交按钮之后才能进行判断，如果出现用户名重复、密码和确认密码不一致等情况，不能及时反馈，可能用户需要多次重复输入信息后才能注册成功